<!DOCTYPE html>
<html lang="id" data-bs-theme="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Riwayat — Fuzzy Sugeno</title>

  <!-- Bootstrap & Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
  <link rel="stylesheet" href="css/style.css">
</head>
<body>
  <!-- Burger FAB (floating, mobile only) -->
  <button id="btnBurger"
          class="burger-fab d-lg-none"
          type="button"
          aria-label="Buka sidebar"
          aria-controls="rail"
          aria-expanded="false">
    <i class="bi bi-list"></i>
  </button>
  <!-- ===== SIDEBAR ===== -->
  <aside id="rail" class="rail" role="navigation" aria-label="Sidebar">
    <a href="#" class="rail__brand">
      <span class="rail__logo">AQ</span>
      <span class="rail__title">Air Quality</span>
    </a>

    <div class="rail__actions">
      <button id="btnExpand" class="btn rail__btn" type="button" aria-expanded="false">
        <i class="bi bi-layout-sidebar"></i><span class="d-none d-lg-inline">Perlebar</span>
      </button>
      <button id="btnTheme" class="btn rail__btn" type="button" aria-pressed="false" aria-label="Ganti tema">
        <i class="bi bi-moon-stars"></i><span class="d-none d-lg-inline">Tema</span>
      </button>
    </div>

    <nav class="rail__nav" id="navPrimary">
      <a class="nav-item" href="index.html">
        <i class="nav-item__icon bi bi-speedometer2"></i><span class="nav-item__label">Dashboard</span>
      </a>
      <a class="nav-item" href="inputs.html">
        <i class="nav-item__icon bi bi-sliders"></i><span class="nav-item__label">Input Sensor</span>
      </a>
      <a class="nav-item" href="kalibrasi.html">
        <i class="nav-item__icon bi bi-toggles2"></i><span class="nav-item__label">Kalibrasi MF</span>
      </a>
      <a class="nav-item" href="riwayat.html" aria-current="page">
        <i class="nav-item__icon bi bi-clock-history"></i><span class="nav-item__label">Riwayat</span>
      </a>
      <a class="nav-item" href="tentang.html">
        <i class="nav-item__icon bi bi-info-circle"></i><span class="nav-item__label">Tentang</span>
      </a>
    </nav>

    <div class="rail__section">
      <nav class="rail__nav" id="navSecondary">
        <a class="nav-item" href="export.html">
          <i class="nav-item__icon bi bi-download"></i><span class="nav-item__label">Export</span>
        </a>
      </nav>
    </div>
  </aside>

  <!-- ===== MAIN ===== -->
  <main id="content" class="content-offset">
    <div class="container py-4">
      <div class="d-flex flex-wrap align-items-center justify-content-between gap-3 mb-3">
        <h1 class="h3 fw-bold mb-0">Riwayat Pembacaan Sensor</h1>
        <div class="toolbar d-flex flex-wrap gap-2">
          <select id="rangeSelect" class="form-select form-select-sm" style="min-width:180px">
            <option value="today">Hari ini</option>
            <option value="7">7 hari terakhir</option>
            <option value="30" selected>30 hari terakhir</option>
            <option value="all">Semua waktu</option>
          </select>
          <button id="btnExportCSV" class="btn btn-outline-primary btn-sm"><i class="bi bi-filetype-csv me-1"></i>CSV</button>
          <button id="btnExportJSON" class="btn btn-outline-secondary btn-sm"><i class="bi bi-braces me-1"></i>JSON</button>
          <button id="btnResetData" class="btn btn-outline-danger btn-sm"><i class="bi bi-trash3 me-1"></i>Hapus Semua</button>
        </div>
      </div>

      <!-- Chart -->
      <div class="card p-3 mb-3">
        <div class="d-flex align-items-center justify-content-between mb-2">
          <h5 class="mb-0">Tren Sensor</h5>
          <small class="text-muted">gabungan pH, NTU, Suhu</small>
        </div>
        <div class="chart-wrap"><canvas id="historyChart"></canvas></div>
      </div>

      <!-- Table -->
      <div class="card p-3">
        <div class="d-flex align-items-center justify-content-between mb-2">
          <h5 class="mb-0">Tabel Riwayat</h5>
          <small id="rowCount" class="text-muted"></small>
        </div>
        <div class="table-responsive">
          <table class="table table-hover align-middle mb-0" id="historyTable">
            <thead>
              <tr>
                <th style="width:56px">#</th>
                <th style="min-width:160px">Waktu</th>
                <th>pH</th>
                <th>NTU</th>
                <th>Suhu (°C)</th>
                <th>Skor</th>
                <th>Label</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody><!-- rows injected --></tbody>
          </table>
        </div>
      </div>
    </div>
  </main>

  <!-- JS libs -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>

  <script>
    /* ====== Utils ====== */
    const $  = (q, s=document) => s.querySelector(q);
    const $$ = (q, s=document) => Array.from(s.querySelectorAll(q));
    const root = document.documentElement;

    // Sidebar + Theme
    const rail = $('#rail'), content = $('#content'), btnExpand = $('#btnExpand'), btnTheme = $('#btnTheme');
    const EXPAND_KEY='railExpanded', THEME_KEY='aqTheme';
    const expanded = localStorage.getItem(EXPAND_KEY)==='true';
    if (expanded){ rail.classList.add('rail--expanded'); content?.classList.add('content-offset--expanded'); btnExpand?.setAttribute('aria-expanded','true'); }
    btnExpand?.addEventListener('click', ()=>{ const isExpanded=rail.classList.toggle('rail--expanded'); content?.classList.toggle('content-offset--expanded'); btnExpand.setAttribute('aria-expanded', String(isExpanded)); localStorage.setItem(EXPAND_KEY,String(isExpanded)); });
    if (!localStorage.getItem(THEME_KEY) && window.matchMedia('(prefers-color-scheme: dark)').matches){ root.setAttribute('data-bs-theme','dark'); }
    const savedTheme = localStorage.getItem(THEME_KEY); if (savedTheme) root.setAttribute('data-bs-theme', savedTheme);
    btnTheme?.addEventListener('click', ()=>{ const next=root.getAttribute('data-bs-theme')==='dark'?'light':'dark'; root.setAttribute('data-bs-theme',next); localStorage.setItem(THEME_KEY,next); refreshChartTheme(); });

    // mark active nav
    $$('a.nav-item').forEach(a=>a.removeAttribute('aria-current'));
    $('a.nav-item[href$="riwayat.html"]')?.setAttribute('aria-current','page');

    /* ====== Fuzzy helpers (sama seperti halaman utama) ====== */
    function trap(x,a,b,c,d){ if (x<=a||x>=d) return 0; if (x>=b && x<=c) return 1; if (x>a && x<b) return (x-a)/(b-a); if (x>c && x<d) return (d-x)/(d-c); return 0; }
    function tri (x,a,b,c){ if (x<=a||x>=c) return 0; if (x===b) return 1; if (x>a && x<b) return (x-a)/(b-a); if (x>b && x<c) return (c-x)/(c-b); return 0; }

    function mu_pH(pH){ return { asam: trap(pH,0,0,5.5,6.5), netral: tri(pH,6.5,7.0,8.5), basa: trap(pH,8.0,9.0,14,14) }; }
    function mu_ntu(ntu){ return { jernih: trap(ntu,0,0,5,25), sedang: tri(ntu,20,100,300), keruh: trap(ntu,250,400,1000,1000) }; }
    function mu_temp(t){ return { dingin: trap(t,0,0,18,24), nyaman: tri(t,22,27,32), panas: trap(t,30,33,40,40) }; }

    function computeScore(pH, ntu, t){
      const p = mu_pH(pH), n = mu_ntu(ntu), s = mu_temp(t);
      const rules = [
        {w: p.netral*n.jernih*s.nyaman, c:95},
        {w: p.netral*n.jernih, c:85},
        {w: p.netral*s.nyaman, c:80},
        {w: n.jernih*s.nyaman, c:80},
        {w: p.netral*n.sedang, c:60},
        {w: p.netral*Math.min(1, s.dingin + s.panas), c:55},
        {w: n.sedang*s.nyaman, c:55},
        {w: p.basa*n.jernih, c:55},
        {w: n.keruh, c:20},
        {w: Math.max(p.asam, p.basa), c:25},
        {w: s.panas*n.keruh, c:20},
        {w: s.dingin*n.jernih, c:50},
      ].map(r=>({w:Math.min(1,r.w), c:r.c}));
      let num=0, den=0; for(const r of rules){ num+=r.w*r.c; den+=r.w; }
      const score = den===0?0:num/den;
      let label='Poor', klass='status-poor';
      if (score>85){ label='Excellent'; klass='status-excellent'; }
      else if (score>65){ label='Good'; klass='status-good'; }
      else if (score>35){ label='Fair'; klass='status-fair'; }
      return { score:+score.toFixed(2), label, klass };
    }

    /* ====== Dummy history (localStorage) ====== */
    const STORE_KEY = 'aq_history';

    function randHistoryPoint(ts){
    // 70% data dalam rentang "normal", 30% ekstrem
    const normal = Math.random() < 0.7;
    const pH  = normal ? +(6.5 + Math.random()*1.5).toFixed(2)  // 6.5–8.0
                        : +(Math.random()*14).toFixed(2);
    const ntu = normal ? Math.round(Math.random()*200)           // 0–200 NTU
                        : Math.round(Math.random()*1000);
    const t   = normal ? +(22 + Math.random()*8).toFixed(1)      // 22–30 °C
                        : +(Math.random()*40).toFixed(1);

    const {score, label, klass} = computeScore(pH, ntu, t);
    return { ts, pH, ntu, t, score, label, klass };
    }

    function ensureHistory(){
      let hist = JSON.parse(localStorage.getItem(STORE_KEY) || '[]');
      if (hist.length===0){
        // generate 200 titik dalam 30 hari terakhir (acak waktunya)
        const now = Date.now(), day = 24*3600*1000;
        for(let i=0;i<200;i++){
          const ts = now - Math.floor(Math.random()*30*day) - Math.floor(Math.random()*day);
          hist.push(randHistoryPoint(ts));
        }
        hist.sort((a,b)=>a.ts-b.ts);
        localStorage.setItem(STORE_KEY, JSON.stringify(hist));
      }
      return hist;
    }

    function clearHistory(){
      localStorage.removeItem(STORE_KEY);
    }

    /* ====== Filter ====== */
    function filterByRange(hist, range){
      const startOf = (d)=> new Date(d.getFullYear(), d.getMonth(), d.getDate()).getTime();
      const now = new Date();
      if (range==='all') return hist;
      if (range==='today'){
        const start = startOf(now);
        return hist.filter(r=> r.ts >= start);
      }
      const days = Number(range)||30;
      const from = Date.now() - days*24*3600*1000;
      return hist.filter(r=> r.ts >= from);
    }

    /* ====== Chart ====== */
    const ctx = document.getElementById('historyChart');
    let chart;

    function chartColors(){
      const cs = getComputedStyle(root);
      return { text: cs.getPropertyValue('--chart-txt').trim(), grid: cs.getPropertyValue('--chart-grid').trim(), bg: cs.getPropertyValue('--chart-bg').trim() };
    }

    function buildChart(labels, series){
      const C = chartColors();
      if (chart) chart.destroy();
      chart = new Chart(ctx, {
        type:'line',
        data:{
          labels,
          datasets:[
            { label:'pH', data:series.pH, borderColor:'#16a34a', backgroundColor:'transparent', tension:.25, borderWidth:2, pointRadius:0, yAxisID:'y' },
            { label:'Suhu (°C)', data:series.temp, borderColor:'#f97316', backgroundColor:'transparent', tension:.25, borderWidth:2, pointRadius:0, yAxisID:'y' },
            { label:'NTU', data:series.ntu, borderColor:'#3b82f6', backgroundColor:'transparent', tension:.25, borderWidth:2, pointRadius:0, yAxisID:'y1' },
          ]
        },
        options:{
          responsive:true, maintainAspectRatio:false, interaction:{mode:'index',intersect:false},
          plugins:{ legend:{ labels:{ color:C.text, font:{weight:'600'} } } },
          scales:{
            x:{ ticks:{color:C.text}, grid:{color:C.grid} },
            y:{ ticks:{color:C.text}, grid:{color:C.grid}, suggestedMin:0, suggestedMax:40 },
            y1:{ position:'right', ticks:{color:C.text}, grid:{drawOnChartArea:false, color:C.grid}, suggestedMin:0, suggestedMax:1000 }
          }
        }
      });
      ctx.style.background = C.bg;
    }
    function refreshChartTheme(){
      if(!chart) return;
      const C = chartColors();
      chart.options.plugins.legend.labels.color = C.text;
      chart.options.scales.x.ticks.color = C.text;
      chart.options.scales.x.grid.color = C.grid;
      chart.options.scales.y.ticks.color = C.text;
      chart.options.scales.y.grid.color = C.grid;
      chart.options.scales.y1.ticks.color = C.text;
      chart.options.scales.y1.grid.color = C.grid;
      chart.canvas.style.background = C.bg;
      chart.update('none');
    }
    new MutationObserver(refreshChartTheme).observe(root,{attributes:true, attributeFilter:['data-bs-theme']});

    /* ====== Table ====== */
    function renderTable(rows){
      const tbody = $('#historyTable tbody');
      tbody.innerHTML = '';
      rows.forEach((r, idx)=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="text-muted">${idx+1}</td>
          <td><span class="text-nowrap">${new Date(r.ts).toLocaleString('id-ID')}</span></td>
          <td>${r.pH}</td>
          <td>${r.ntu}</td>
          <td>${r.t}</td>
          <td>${r.score}</td>
          <td><span class="badge badge-status ${r.klass}">${r.label}</span></td>
          <td>${statusFromLabel(r.label)}</td>
        `;
        tbody.appendChild(tr);
      });
      $('#rowCount').textContent = `${rows.length} baris`;
    }

    function statusFromLabel(label){
      switch(label){
        case 'Excellent': return '<i class="bi bi-check2-circle text-success"></i> Baik Sekali';
        case 'Good': return '<i class="bi bi-hand-thumbs-up text-primary"></i> Baik';
        case 'Fair': return '<i class="bi bi-exclamation-triangle text-warning"></i> Sedang';
        default: return '<i class="bi bi-x-circle text-danger"></i> Buruk';
      }
    }

    /* ====== Export ====== */
    function exportJSON(rows){
      const blob = new Blob([JSON.stringify(rows,null,2)], {type:'application/json'});
      const a = Object.assign(document.createElement('a'), { href: URL.createObjectURL(blob), download: 'riwayat.json' });
      document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(a.href);
    }
    function exportCSV(rows){
      const header = ['timestamp','waktu','pH','NTU','suhu','skor','label'];
      const lines = rows.map(r=>[
        r.ts,
        `"${new Date(r.ts).toLocaleString('id-ID')}"`,
        r.pH, r.ntu, r.t, r.score, r.label
      ].join(','));
      const csv = [header.join(','), ...lines].join('\n');
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const a = Object.assign(document.createElement('a'), { href: URL.createObjectURL(blob), download: 'riwayat.csv' });
      document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(a.href);
    }

    /* ====== Main render pipeline ====== */
    let HISTORY = ensureHistory();

    function applyRange(){
      const range = $('#rangeSelect').value;
      const filtered = filterByRange(HISTORY, range);
      // sort ascending to draw properly
      filtered.sort((a,b)=>a.ts-b.ts);

      // build chart data
      const labels = filtered.map(r=> new Date(r.ts).toLocaleString('id-ID'));
      const series = {
        pH: filtered.map(r=> r.pH),
        ntu: filtered.map(r=> r.ntu),
        temp: filtered.map(r=> r.t),
      };
      buildChart(labels, series);
      // table (descending for latest first)
      const tableRows = filtered.slice().sort((a,b)=>b.ts-a.ts);
      renderTable(tableRows);
    }

    // Events
    $('#rangeSelect').addEventListener('change', applyRange);
    $('#btnExportCSV').addEventListener('click', ()=> exportCSV(filterByRange(HISTORY, $('#rangeSelect').value).sort((a,b)=>a.ts-b.ts)));
    $('#btnExportJSON').addEventListener('click', ()=> exportJSON(filterByRange(HISTORY, $('#rangeSelect').value).sort((a,b)=>a.ts-b.ts)));
    $('#btnResetData').addEventListener('click', ()=>{
      if (!confirm('Hapus semua data dummy riwayat?')) return;
      clearHistory();
      HISTORY = ensureHistory();
      applyRange();
    });

    // Init
    applyRange();
  </script>
  <script src="js/sidebar.js  "></script>
</body>
</html>
